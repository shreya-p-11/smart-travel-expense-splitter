<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Travel Expense Splitter</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="container">

  <!-- HEADER -->
  <header>
    <h1>ğŸ§³ Smart Travel Expense Splitter</h1>
    <p class="subtitle">Fair, transparent expense sharing for real trips</p>
  </header>

  <!-- TRIP SETUP -->
  <section class="card">
    <h2>âœˆï¸ Trip Setup</h2>
    <form method="POST" action="/create-trip">
      <input name="trip_name" placeholder="Trip name" required>
      <input name="participants" placeholder="Participants (comma separated)" required>
      <div class="row">
        <input type="date" name="start_date" required>
        <input type="number" name="duration" placeholder="Days" required>
      </div>
      <button>Create Trip</button>
    </form>
  </section>

  {% if trip_id %}

  <!-- ADD EXPENSE -->
  <section class="card">
    <h2>ğŸ’³ Add Expense</h2>
    <form method="POST" action="/add-expense">

      <select name="category" required>
        {% for c in categories %}
          <option value="{{c}}">{{c}}</option>
        {% endfor %}
      </select>

      <select name="payer" required>
        {% for p in participants %}
          <option value="{{p.participant_id}}">{{p.name}}</option>
        {% endfor %}
      </select>

      <!-- BENEFICIARIES -->
      <div class="beneficiaries">
        <p><strong>Who benefited?</strong></p>
        {% for p in participants %}
          <label>
            <input type="checkbox" name="beneficiaries" value="{{p.participant_id}}" checked>
            {{p.name}}
          </label>
        {% endfor %}
      </div>

      <input type="number" name="amount" placeholder="Amount paid" required>
      <input type="date" name="expense_date">
      <textarea name="note" placeholder="Optional note"></textarea>

      <button>Add Expense</button>
    </form>
  </section>

  <!-- EXPENSE HISTORY -->
  <section class="card">
    <h2>ğŸ“œ Expense History</h2>
    {% for e in expenses %}
      <div class="list-item">
        <strong>{{e.category}}</strong> â€” â‚¹{{e.amount}}
        <span>paid by {{ payer_name_map[e.payer_id] }}</span>
      </div>
    {% else %}
      <p>No expenses yet.</p>
    {% endfor %}
  </section>

  <!-- SUMMARY -->
  <section class="card">
    <h2>âš–ï¸ Settlement Summary</h2>
    {% for person in summary %}
      <div class="summary-row">
        <strong>{{person.name}}</strong>
        <span>Paid: â‚¹{{person.paid}}</span>
        <span>Share: â‚¹{{person.share}}</span>
        <span>
          {% if person.net > 0 %}
            Gets back â‚¹{{person.net}}
          {% elif person.net < 0 %}
            Owes â‚¹{{-person.net}}
          {% else %}
            Settled
          {% endif %}
        </span>
      </div>
    {% endfor %}
  </section>

  <!-- WHO PAYS WHOM -->
  <section class="card">
    <h2>ğŸ” Who Pays Whom</h2>
    {% for s in settlements %}
      <div class="settlement">
        ğŸ‘‰ <strong>{{s.from}}</strong> pays <strong>{{s.to}}</strong> â‚¹{{s.amount}}
      </div>
    {% else %}
      <p>No settlements needed ğŸ‰</p>
    {% endfor %}
  </section>

  <!-- BUDGET -->
<section class="card">
  <h2>ğŸ’° Trip Budget</h2>

  <input
    type="number"
    id="budgetInput"
    placeholder="Enter total trip budget"
    style="margin-bottom:10px;"
  >

  <p id="budgetStatus"></p>
</section>


  <!-- INSIGHTS WITH CHARTS -->
  <section class="card">
    <h2>ğŸ“Š Insights</h2>

    <!-- SAFELY INJECT ANALYTICS JSON -->
    <script id="analytics-json" type="application/json">
      {{ analytics | tojson | safe }}
    </script>

   <canvas id="categoryChart" width="250" height="250"></canvas>

    <canvas id="dailyChart" style="margin-top:30px;"></canvas>

    <script>
      const analyticsData = JSON.parse(
        document.getElementById("analytics-json").textContent
      );

      const categoryData = analyticsData.category_breakdown || {};
      const dailyData = analyticsData.daily_spending || {};

      if (Object.keys(categoryData).length > 0) {
        new Chart(document.getElementById("categoryChart"), {
          type: "pie",
          data: {
            labels: Object.keys(categoryData),
            datasets: [{
              data: Object.values(categoryData)
            }]
          }
        });
      }

      if (Object.keys(dailyData).length > 0) {
        new Chart(document.getElementById("dailyChart"), {
          type: "line",
          data: {
            labels: Object.keys(dailyData),
            datasets: [{
              label: "Daily Spend",
              data: Object.values(dailyData),
              fill: false
            }]
          }
        });
      }
    </script>
    <script>
  // --- Budget Logic ---
  const totalSpent = Object.values(categoryData)
    .reduce((a, b) => a + b, 0);

  const budgetInput = document.getElementById("budgetInput");
  const budgetStatus = document.getElementById("budgetStatus");

  budgetInput?.addEventListener("input", () => {
    const budget = parseFloat(budgetInput.value);
    if (!budget || budget <= 0) {
      budgetStatus.textContent = "";
      return;
    }

    const remaining = budget - totalSpent;

    if (remaining >= 0) {
      budgetStatus.innerHTML =
        `âœ… Spent â‚¹${totalSpent} / â‚¹${budget} â€” Remaining â‚¹${remaining}`;
    } else {
      budgetStatus.innerHTML =
        `âš ï¸ Budget exceeded by â‚¹${Math.abs(remaining)}`;
      budgetStatus.style.color = "red";
    }
  });
</script>

  </section>

  <!-- TRANSPARENCY -->
  <section class="card">
    <h2>ğŸ” Expense Breakdown (Transparency)</h2>

    {% for person, data in explanations.items() %}
      <div class="breakdown">
        <h3>{{person}}</h3>

        {% for d in data.details %}
          <p>
            {{d.category}} â‚¹{{d.amount}} â†’
            split among {{d.beneficiaries}} people â†’
            {{person}}â€™s share = â‚¹{{d.share}}
          </p>
        {% endfor %}

        <p><strong>Total Paid:</strong> â‚¹{{data.total_paid}}</p>
        <p><strong>Total Share:</strong> â‚¹{{data.total_share}}</p>
        <p><strong>Net:</strong> â‚¹{{data.net}}</p>
      </div>
    {% endfor %}
  </section>

  <!-- WARNINGS -->
  {% if warnings %}
  <section class="card warning">
    <h2>âš ï¸ Smart Warnings</h2>
    {% for w in warnings %}
      <p>âš ï¸ {{w}}</p>
    {% endfor %}
  </section>
  {% endif %}

  <!-- EXPORT -->
  <section class="card">
    <h2>ğŸ§¾ Export</h2>
    <a href="/export" class="btn-secondary">Download Trip Report</a>
  </section>

  {% endif %}

</div>
</body>
</html>
